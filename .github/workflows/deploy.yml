name: Deploy (Cloudflare Pages)

on:
  push:
    branches:
      - 'main'
      - 'beta'
      - '**'

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - nxApp: portfolio
            cfProject: william-strothe
            distDir: dist/apps/portfolio/browser

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.8.0
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      # âœ… Nx Cloud token selection (RW for main/beta, read for everything else)
      - name: Set Nx Cloud token
        shell: bash
        run: |
          if [ "${{ github.ref_name }}" = "main" ] || [ "${{ github.ref_name }}" = "beta" ]; then
            echo "NX_CLOUD_ACCESS_TOKEN=${{ secrets.NX_CLOUD_ACCESS_TOKEN_RW }}" >> $GITHUB_ENV
          else
            echo "NX_CLOUD_ACCESS_TOKEN=${{ secrets.NX_CLOUD_ACCESS_TOKEN_READ }}" >> $GITHUB_ENV
          fi

      - name: Build ${{ matrix.nxApp }}
        run: pnpm exec nx build ${{ matrix.nxApp }} --configuration=production

      # Production (main) -> no branch flag
      - name: Deploy Production (${{ matrix.nxApp }})
        if: ${{ github.ref_name == 'main' }}
        run: |
          pnpm dlx wrangler@3 pages deploy "${{ matrix.distDir }}" \
            --project-name="${{ matrix.cfProject }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Beta (beta) -> branch "beta"
      - name: Deploy Beta (${{ matrix.nxApp }})
        if: ${{ github.ref_name == 'beta' }}
        run: |
          pnpm dlx wrangler@3 pages deploy "${{ matrix.distDir }}" \
            --project-name="${{ matrix.cfProject }}" \
            --branch="beta"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Preview (everything else) -> branch name
      - name: Deploy Preview (${{ matrix.nxApp }})
        if: ${{ github.ref_name != 'main' && github.ref_name != 'beta' }}
        run: |
          pnpm dlx wrangler@3 pages deploy "${{ matrix.distDir }}" \
            --project-name="${{ matrix.cfProject }}" \
            --branch="${{ github.ref_name }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
