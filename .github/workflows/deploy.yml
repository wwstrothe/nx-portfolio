name: Deploy (Cloudflare Pages)

on:
  # Auto-deploy previews and beta on push (but NOT main)
  push:
    branches-ignore:
      - main

  # Manual production deploy
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'Type "deploy" to confirm production deploy'
        required: true
        default: ''


permissions:
  contents: read

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref }}

  cancel-in-progress: true

jobs:
  # ======================================================
  # Preview + Beta deploys (auto on push, excluding main)
  # ======================================================
  deploy-preview-or-beta:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - nxApp: portfolio
            cfProject: william-strothe
            distDir: dist/apps/portfolio/browser


    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.8.0
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build (${{ matrix.nxApp }})
        run: pnpm exec nx build ${{ matrix.nxApp }} --configuration=production

      - name: Deploy Preview/Beta (${{ matrix.nxApp }} -> ${{ matrix.cfProject }})
        run: |
          pnpm dlx wrangler@3 pages deploy "${{ matrix.distDir }}" \
            --project-name="${{ matrix.cfProject }}" \
            --branch="${{ github.ref_name }}"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # ======================================================
  # Production deploy (manual approval via workflow_dispatch)
  # ======================================================
  deploy-production:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.confirm_production == 'deploy' && github.ref_name == 'main' }}
    runs-on: ubuntu-latest
    environment: production

    strategy:
      fail-fast: false
      matrix:
        include:
          - nxApp: portfolio
            cfProject: william-strothe
            distDir: dist/apps/portfolio/browser

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9.8.0
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build (${{ matrix.nxApp }})
        run: pnpm exec nx build ${{ matrix.nxApp }} --configuration=production

      - name: Deploy Production (${{ matrix.nxApp }} -> ${{ matrix.cfProject }})
        run: |
          pnpm dlx wrangler@3 pages deploy "${{ matrix.distDir }}" \
            --project-name="${{ matrix.cfProject }}"

        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  production-confirmation-guard:
    if: ${{ github.event_name == 'workflow_dispatch' && (inputs.confirm_production != 'deploy' || github.ref_name != 'main') }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "Production deploy blocked."
          echo "1) Run this workflow on the main branch."
          echo '2) Type "deploy" into confirm_production.'
          exit 1
